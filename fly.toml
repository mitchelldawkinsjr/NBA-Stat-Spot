# fly.toml app configuration file
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.

app = "nba-stat-spot-ai"
primary_region = "iad"

[build]
  dockerfile = "Dockerfile"

[env]
  ENV = "production"
  PORT = "8000"
  # CORS_ORIGINS is set via fly secrets (run: fly secrets set CORS_ORIGINS="...")
  DATABASE_URL = "sqlite:///./nba_props.db"
  # API-Sports.io Basketball configuration (set via fly secrets)
  # API_NBA_KEY = "your-api-sports-key-here"  # Set via: fly secrets set API_NBA_KEY="your-key"
  # API_NBA_USE_RAPIDAPI = "false"            # Set to "true" if using RapidAPI (default: "false")
  # API_NBA_RATE_LIMIT_PER_MINUTE = "10"      # Optional override (default: 10)
  # API_NBA_RATE_LIMIT_PER_DAY = "100"        # Optional override (default: 100 for free tier)
  # ESPN rate limit configuration (optional overrides)
  # ESPN_RATE_LIMIT_PER_MINUTE = "100"      # Optional override (default: 100)
  # ESPN_RATE_LIMIT_PER_HOUR = "1000"       # Optional override (default: 1000)

[processes]
  # Port is set to 8000 in [env] section and matches internal_port
  app = "python -m uvicorn app.main:app --host 0.0.0.0 --port 8000"
  cron = "supercronic /app/crontab"

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = "off"  # Keep running to avoid cold starts - use "off" string to disable auto-stop
  auto_start_machines = true
  min_machines_running = 1    # Always keep 1 machine ready
  processes = ["app"]
  
  # Health check for better reliability
  # Increased timeout and grace period to prevent unnecessary restarts
  [[http_service.checks]]
    grace_period = "30s"      # Increased from 10s - give app more time to start
    interval = "30s"          # Check every 30 seconds
    method = "GET"
    timeout = "10s"           # Increased from 5s - allow more time for response
    path = "/healthz"
    tls_skip_verify = false

[[vm]]
  cpu_kind = "shared"    # Shared CPUs are much cheaper than dedicated
  cpus = 2                # 2x CPUs for parallel processing (stat-leaders endpoint)
  memory_mb = 1024        # Increased from 512MB to prevent OOM crashes
